<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UCI Digital Wastebin Scale: scale_optimized.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UCI Digital Wastebin Scale
   </div>
   <div id="projectbrief">Used for interacting with the scale of the bin</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">scale_optimized.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>contain functions used for scale I/O  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;assert.h&gt;</code><br />
<code>#include &lt;errno.h&gt;</code><br />
<code>#include &lt;fcntl.h&gt;</code><br />
<code>#include &lt;math.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;strings.h&gt;</code><br />
<code>#include &lt;sys/select.h&gt;</code><br />
<code>#include &lt;termios.h&gt;</code><br />
<code>#include &lt;time.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &quot;<a class="el" href="scale__optimized_8h_source.html">scale_optimized.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="scale__utils_8h_source.html">scale_utils.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for scale_optimized.c:</div>
<div class="dyncontent">
<div class="center"><img src="scale__optimized_8c__incl.png" border="0" usemap="#scale__optimized_8c" alt=""/></div>
<map name="scale__optimized_8c" id="scale__optimized_8c">
<area shape="rect" id="node15" href="scale__optimized_8h.html" title="Header file containing ERROR codes and SCALE return code. " alt="" coords="498,80,625,107"/>
<area shape="rect" id="node16" href="scale__utils_8h.html" title="header file for scale utilities " alt="" coords="1229,80,1323,107"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ae795333775ebb9d127fd2c77f0afaad9"><td class="memItemLeft" align="right" valign="top"><a id="ae795333775ebb9d127fd2c77f0afaad9"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>SCALE_DEV_FILE</b>&#160;&#160;&#160;&quot;/dev/ttyUSB0&quot;</td></tr>
<tr class="separator:ae795333775ebb9d127fd2c77f0afaad9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a485c63ac55db1585fc6858dcee6adfc9"><td class="memItemLeft" align="right" valign="top"><a id="a485c63ac55db1585fc6858dcee6adfc9"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#a485c63ac55db1585fc6858dcee6adfc9">SCALE_MESSAGE_SIZE</a>&#160;&#160;&#160;6</td></tr>
<tr class="memdesc:a485c63ac55db1585fc6858dcee6adfc9"><td class="mdescLeft">&#160;</td><td class="mdescRight">defined by the manual <br /></td></tr>
<tr class="separator:a485c63ac55db1585fc6858dcee6adfc9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3ebde3e5864449d18f729e0db652fd5"><td class="memItemLeft" align="right" valign="top"><a id="ae3ebde3e5864449d18f729e0db652fd5"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#ae3ebde3e5864449d18f729e0db652fd5">RECONNECT_ATTEMPTS</a>&#160;&#160;&#160;5</td></tr>
<tr class="memdesc:ae3ebde3e5864449d18f729e0db652fd5"><td class="mdescLeft">&#160;</td><td class="mdescRight">how many times the code will try connecting to scale or the savefile before giving up <br /></td></tr>
<tr class="separator:ae3ebde3e5864449d18f729e0db652fd5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a475f469714cf28b99c548265acdbef68"><td class="memItemLeft" align="right" valign="top"><a id="a475f469714cf28b99c548265acdbef68"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LBS_TO_OUNCE_CONV</b>&#160;&#160;&#160;16.0</td></tr>
<tr class="separator:a475f469714cf28b99c548265acdbef68"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a319ac82d58cf14c594ecbd25fcfd776f"><td class="memItemLeft" align="right" valign="top"><a id="a319ac82d58cf14c594ecbd25fcfd776f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#a319ac82d58cf14c594ecbd25fcfd776f">WEIGHT_THRESHOLD</a>&#160;&#160;&#160;0.1</td></tr>
<tr class="memdesc:a319ac82d58cf14c594ecbd25fcfd776f"><td class="mdescLeft">&#160;</td><td class="mdescRight">min increase in lbs before we consider it a change in weight <br /></td></tr>
<tr class="separator:a319ac82d58cf14c594ecbd25fcfd776f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4bf668adfa64148dbb46fc8738bbe394"><td class="memItemLeft" align="right" valign="top"><a id="a4bf668adfa64148dbb46fc8738bbe394"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#a4bf668adfa64148dbb46fc8738bbe394">OPEN_SCALE_TRIAL</a>&#160;&#160;&#160;5</td></tr>
<tr class="memdesc:a4bf668adfa64148dbb46fc8738bbe394"><td class="mdescLeft">&#160;</td><td class="mdescRight">how many times we try to open the scale before exit <br /></td></tr>
<tr class="separator:a4bf668adfa64148dbb46fc8738bbe394"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a206fab870ab3877a537894fac4cd9788"><td class="memItemLeft" align="right" valign="top"><a id="a206fab870ab3877a537894fac4cd9788"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#a206fab870ab3877a537894fac4cd9788">CLOST_SCALE_TRIAL</a>&#160;&#160;&#160;6</td></tr>
<tr class="memdesc:a206fab870ab3877a537894fac4cd9788"><td class="mdescLeft">&#160;</td><td class="mdescRight">how many times we try to close the scale before exit <br /></td></tr>
<tr class="separator:a206fab870ab3877a537894fac4cd9788"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abe973f7a54a96bfa13e62343746f6b2e"><td class="memItemLeft" align="right" valign="top"><a id="abe973f7a54a96bfa13e62343746f6b2e"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#abe973f7a54a96bfa13e62343746f6b2e">SCALE_SIGNATURE</a>&#160;&#160;&#160;255</td></tr>
<tr class="memdesc:abe973f7a54a96bfa13e62343746f6b2e"><td class="mdescLeft">&#160;</td><td class="mdescRight">signature value of the first byte given by manufacturer <br /></td></tr>
<tr class="separator:abe973f7a54a96bfa13e62343746f6b2e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:abe3c361bf6bda6b92e9204274c2870b6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#abe3c361bf6bda6b92e9204274c2870b6">openScale</a> (FILE *log)</td></tr>
<tr class="memdesc:abe3c361bf6bda6b92e9204274c2870b6"><td class="mdescLeft">&#160;</td><td class="mdescRight">creat file descriptor for talking with scale  <a href="#abe3c361bf6bda6b92e9204274c2870b6">More...</a><br /></td></tr>
<tr class="separator:abe3c361bf6bda6b92e9204274c2870b6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2612526b3835ed315ed135420667a59c"><td class="memItemLeft" align="right" valign="top">float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#a2612526b3835ed315ed135420667a59c">readScale</a> (int scale, fd_set *inputSet, struct timeval *timeOut, FILE *log)</td></tr>
<tr class="memdesc:a2612526b3835ed315ed135420667a59c"><td class="mdescLeft">&#160;</td><td class="mdescRight">read the scale if enough data is available  <a href="#a2612526b3835ed315ed135420667a59c">More...</a><br /></td></tr>
<tr class="separator:a2612526b3835ed315ed135420667a59c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acfd015f86d96ddc2993d7a11d39e3f19"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#acfd015f86d96ddc2993d7a11d39e3f19">sendScaleResult</a> (float scaleResult, char *saveFileName, FILE *log, const char *mode)</td></tr>
<tr class="memdesc:acfd015f86d96ddc2993d7a11d39e3f19"><td class="mdescLeft">&#160;</td><td class="mdescRight">send scale result to the display portion, may change in the future  <a href="#acfd015f86d96ddc2993d7a11d39e3f19">More...</a><br /></td></tr>
<tr class="separator:acfd015f86d96ddc2993d7a11d39e3f19"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed7cea49e2d478aefcfb61936502d4e8"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="scale__optimized_8c.html#aed7cea49e2d478aefcfb61936502d4e8">closeScale</a> (int scale, FILE *log)</td></tr>
<tr class="memdesc:aed7cea49e2d478aefcfb61936502d4e8"><td class="mdescLeft">&#160;</td><td class="mdescRight">close the scale and the log associated with it  <a href="#aed7cea49e2d478aefcfb61936502d4e8">More...</a><br /></td></tr>
<tr class="separator:aed7cea49e2d478aefcfb61936502d4e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>contain functions used for scale I/O </p>
<dl class="section author"><dt>Author</dt><dd>Khoi Trinh Contain all functions that work directly with the scale file desciptor </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="aed7cea49e2d478aefcfb61936502d4e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed7cea49e2d478aefcfb61936502d4e8">&#9670;&nbsp;</a></span>closeScale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int closeScale </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&#160;</td>
          <td class="paramname"><em>log</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>close the scale and the log associated with it </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">scale</td><td>file descriptor for the scale </td></tr>
    <tr><td class="paramname">log</td><td>file descriptor for log </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>error code or 0 for success </dd></dl>

</div>
</div>
<a id="abe3c361bf6bda6b92e9204274c2870b6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe3c361bf6bda6b92e9204274c2870b6">&#9670;&nbsp;</a></span>openScale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int openScale </td>
          <td>(</td>
          <td class="paramtype">FILE *&#160;</td>
          <td class="paramname"><em>log</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>creat file descriptor for talking with scale </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">log</td><td>this is the log file dedicated only to the scale </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>scale file descriptor that will be used for the rest of the communications or negative error code</dd></dl>
<p>The settings of the scale communications is as follow:</p><ul>
<li>9600 baudrate, this is the max the scale can do</li>
<li>No parity, the scale doesn't have error checking</li>
<li>No output config since the scale doesn't receive command</li>
<li>Canonical mode with Blocking read and wait until at least 6 bytes</li>
<li>Data frame is 8 bit data, 1 stop bit </li>
</ul>

</div>
</div>
<a id="a2612526b3835ed315ed135420667a59c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2612526b3835ed315ed135420667a59c">&#9670;&nbsp;</a></span>readScale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">float readScale </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">fd_set *&#160;</td>
          <td class="paramname"><em>inputSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct timeval *&#160;</td>
          <td class="paramname"><em>timeOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&#160;</td>
          <td class="paramname"><em>log</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>read the scale if enough data is available </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">scale</td><td>the scale descriptor </td></tr>
    <tr><td class="paramname">inputSet</td><td>file descriptor set used with select </td></tr>
    <tr><td class="paramname">timeOut</td><td>timeval struct containing timeout info</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>float represents the increase in weight in ounces or 0 for scale weight remaining the same or error code, all negative numbers returned are error code since weight decreasing is ignored except for one case where the trashbag is detected to have been replaced, the function will adjust the var that stored prev reading accordingly</dd></dl>
<p>The function stores some data about the previous scale reading and compare with the current one to decide if the data has changed, this reduced waste of time spent processing repeated data, consult the scale manual for data frame example, once the scale has identified that the frame is a valid one based on the flag, it will process the bits accordingly </p>

</div>
</div>
<a id="acfd015f86d96ddc2993d7a11d39e3f19"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acfd015f86d96ddc2993d7a11d39e3f19">&#9670;&nbsp;</a></span>sendScaleResult()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int sendScaleResult </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>scaleResult</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>saveFileName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&#160;</td>
          <td class="paramname"><em>log</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>mode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>send scale result to the display portion, may change in the future </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mode</td><td>this is the mode of the scale, found by reading env variable on the pi</td></tr>
  </table>
  </dd>
</dl>
<p>Will open the file every time and close it after write because another process is reading this file so need to limit open time of the scale result file, if the first attempt fail, it will retry multiple times but if they all fail then, the write format currently follows json file </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
